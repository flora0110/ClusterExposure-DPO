# ClusterExposure-DPO: LLM-based Recommendation via Cluster-Aware Exposure-Aware Negative Sampling

## Inspiration & Methodology

This project is primarily inspired by two papers:

- [SPRec](https://arxiv.org/abs/2412.09243): Self-Play to Debias LLM-based Recommendation

    ↳ Introduces self-play for negative sampling by using LLM-generated predictions as rejections.

- [S-DPO](https://arxiv.org/abs/2406.09215): Softmax Direct Preference Optimization (not yet been fully reproduced)

    ↳ Proposes the use of multiple negative samples in the DPO framework.

Building on SPRec's self-play foundation, this work proposes a Cluster-Aware and Exposure-Aware Negative Sampling framework, which selects hard negatives based on both:

- User preference clusters (inferred from past behavior)

- Exposure statistics (popularity and frequency of each item)

We combine these signals to generate more challenging and diverse negative samples, and evaluate their effectiveness under DPO fine-tuning across eight distinct sampling strategies.


## Pipeline

Our training pipeline consists of:

1. Self-Play Generation
    
    - Generate top‑k model-preferred candidates using beam search with constrained decoding, ensuring all outputs are valid in-database items from Goodreads via a Trie-based constraint.

2. Negative Sampling
    
    - Based on each user's preference clusters and the candidates' exposure levels, selectively choose challenging negative samples.

3. DPO/S-DPO Fine-Tuning
    
    - Fine-tune the model using DPO/S-DPO, training it to prefer the ground-truth item over selected negatives.

4. Evaluation

    - Assess performance on NDCG, HR, diversity, genre fairness, and over-recommendation.

## Key Innovations

This work builds on the Self-Play framework (e.g., SPRec), where hard negatives are generated by selecting the model’s most confident predictions.

Our key contribution is a Cluster-Exposure-Aware enhancement to this paradigm:

- We use beam search with constrained decoding over a Trie to ensure generated candidates are both valid and high-confidence entries from the item database.

- Then, we incorporate user preference clusters (derived from past behavior) and item exposure statistics to filter and select high-quality hard negatives.

This design leads to better coverage of long-tail and diverse genres, while maintaining high ranking performance, outperforming vanilla self-play in both fairness and accuracy metrics.

## Setup
Moedl: HuggingFaceTB/SmolLM2-1.7B-Instruct

## Metrics

We report top-5 and top-10 metrics including:

    - Ranking metrics: NDCG@k, HR@k

    - Diversity: unique item count, DivRatio

    - Fairness: DGU, MGU

    - Over-recommendation: ORRatio

    - Validity: Predict_NotIn_Ratio

## Results Summery

### Comparative Analysis of Negative‑Sampling Methods on Goodreads

Negative Sampling Strategies

- clusterout_low: User-Preference-Clusters‑aware, sampling negatives outside interest clusters with low exposure.

- clusterin_high_clusterout_low: Hybrid—one high‑exposure negative inside the cluster + one low‑exposure negative outside.

SampleMethod | MGU@5 ↓ | DGU@5 ↓ | DivRatio@5 ↑ | ORRatio@5 ↓ | NDCG@5 ↑ | HR@5 ↑ |
| --- | --- | --- | --- | --- | --- | --- |
| ClusterExposure-DPO(clusterout_low) | 0.0186| <mark>**0.0644**</mark> | <mark>**0.1366**</mark> | 0.0966 | <mark>**0.0211**</mark> | <mark>**0.0330**</mark> |
| ClusterExposure-DPO(clusterin_high_clusterout_low) | <mark>**0.0175**</mark> | 0.0650 | 0.1292 | 0.0946 | 0.0200 | 0.030 |
| SPRec(Baseline) | 0.0228 | 0.0789 | 0.1266 | <mark>**0.0870**</mark> | 0.0140 | 0.0220 |


- clusterout_low leads on diversity (DivRatio@5 0.1366) and ranking (NDCG@5 0.0211, HR@5 0.0330).
- clusterin_high_clusterout_low achieves the lowest MGU@5 (0.0175) and reduces ORRatio@5 compared to clusterout_low (0.0946 vs. 0.0966).
- SPRec still holds the best ORRatio@5 (0.0870) but lags in diversity and ranking.




| SampleMethod | MGU@10 ↓ | DGU@10 ↓ | DivRatio@10 ↑ | ORRatio@10 ↓ | NDCG@10 ↑ | HR@10 ↑ |
| --- | --- | --- | --- | --- | --- | --- |
| ClusterExposure-DPO(clusterout_low) | 0.0129 | 0.0436 | <mark>**0.1026**</mark> | 0.0648 | <mark>**0.0230**</mark> | <mark>**0.039**</mark> |
| ClusterExposure-DPO(clusterin_high_clusterout_low) | <mark>**0.0113**</mark> | <mark>**0.0404**</mark> | 0.0999 | <mark>**0.0623**</mark> | 0.0216 | 0.035 |
| SPRec(Baseline) | 0.0141 | 0.0450 | 0.0968 | <mark>**0.0623**</mark> | 0.0158 | 0.028 |


- clusterout_low again yields the highest diversity (0.1026) and best NDCG/HR.

- clusterin_high_clusterout_low further lowers MGU@10 and DGU@10 (0.0113, 0.0404), matching the best ORRatio@10 (0.0623).

- SPRec retains best ORRatio but has the weakest diversity/ranking.



| SampleMethod | MGU@5 ↓ | DGU@5 ↓ | DivRatio@5 ↑ | ORRatio@5 ↓ | NDCG@5 ↑ | HR@5 ↑ |
| --- | --- | --- | --- | --- | --- | --- |
| low_exposure | 0.0201 | 0.0743 | 0.1284 | 0.0986 | 0.0166 | 0.025 |
| high_exposure | 0.0187 | 0.0655 | 0.1366 | 0.1200 | 0.0150 | 0.023 |
| clusterin_low | 0.0196 | 0.0730 | 0.1292 | 0.0978 | 0.0170 | 0.027 |
| clusterin_high | 0.0187 | 0.0656 | 0.1368 | 0.1202 | 0.0150 | 0.023 |
| clusterout_low | 0.0186 |0.0644 | 0.1366 | 0.0966 | 0.0211 | 0.033|
| clusterout_high | 0.0185 | 0.0652 | 0.1300 | 0.1154 | 0.0151 | 0.023 |
| clusterin_low_clusterout_low | 0.0186 | 0.0708 | 0.1256 | 0.0896 | 0.0177 | 0.027 |
| clusterin_high_clusterout_low | 0.0175 | 0.0650 | 0.1292 | 0.0946 | 0.0200 | 0.030 |

- No matter whether the negative samples come from within-cluster or out-of-cluster, choosing low-exposure items consistently leads to a better (lower) ORRatio. This challenges the common assumption that penalizing high-exposure items—by pushing them farther away from positive items—would help reduce ORRatio. In contrast, while penalizing low-exposure items reduces their likelihood of being recommended given a specific past behavior sequence, it may indirectly bring them closer to other user behavior patterns due to this "push-away" effect. Therefore, the relationship between exposure-based penalization and ORRatio is more nuanced than expected.


### Key Takeaways

- Reducing Bias: clusterin_high_clusterout_low is best at mitigating genre/popularity bias (MGU, DGU, ORRatio), especially at Top‑10.

- Maximizing Diversity & Accuracy: clusterout_low consistently leads in diversity (DivRatio) and retrieval quality (NDCG, HR).

- Baseline SPRec: Excels only on ORRatio but underperforms on diversity and ranking metrics.


## Experiments

### Negative Sampling Strategies

| Strategy Name | Description |
| --- | --- |
| balanced_popularity | Randomly select from high/low exposure halves |
| clusterin_high | In-cluster candidate with highest exposure |
| clusterin_low | In-cluster candidate with lowest exposure |
| low_exposure | Globally lowest exposure candidate |
| high_exposure | Globally highest exposure candidate |
| clusterout_low | Out-of-cluster candidate with lowest exposure |
| clusterout_high | Out-of-cluster candidate with highest exposure |
| clusterin_high_clusterout_low | One in-cluster high exposure + one out-of-cluster low exposure candidate |

### Top-5 Metrics

| SampleMethod | MGU@5 ↓ | DGU@5 ↓ | DivRatio@5 ↑ | ORRatio@5 ↓ | NDCG@5 ↑ | HR@5 ↑ |
| --- | --- | --- | --- | --- | --- | --- |
| SPRec(Baseline) | 0.0228 | 0.0789 | 0.1266 | <mark>**0.0870**</mark> | 0.0140 | 0.022 |
| clusterout_high | 0.0185 | 0.0652 | 0.1300 | 0.1154 | 0.0151 | 0.023 |
| low_exposure | 0.0201 | 0.0743 | 0.1284 | 0.0986 | 0.0166 | 0.025 |
| high_exposure | 0.0187 | 0.0655 | 0.1366 | 0.1200 | 0.0150 | 0.023 |
| clusterin_high | 0.0187 | 0.0656 | <mark>**0.1368**</mark> | 0.1202 | 0.0150 | 0.023 |
| clusterout_low | 0.0186 | <mark>**0.0644**</mark> | 0.1366 | 0.0966 | <mark>**0.0211**</mark> | <mark>**0.033**</mark> |
| clusterin_low | 0.0196 | 0.0730 | 0.1292 | 0.0978 | 0.0170 | 0.027 |
| clusterin_high_clusterout_low | <mark>**0.0175**</mark> | 0.0650 | 0.1292 | 0.0946 | 0.0200 | 0.030 |
| balanced_popularity | 0.0183 | 0.0682 | 0.1296 | 0.0950 | 0.0194 | 0.029 |
| clusterin_low_clusterout_low | 0.0186 | 0.0708 | 0.1256 | 0.0896 | 0.0177 | 0.027 |
| LightGCN(all) | 0.0214 | 0.0749 | 0.1232 | 0.1146 | 0.0117 | 0.0190 |
| out_past_farthest | 0.0172 | 0.0634 | 0.1450 | 0.0822 | 0.0234 | 0.035 |
| in_chosen_nearest | 0.0195 | 0.0672 | 0.1324 | 0.1022 | 0.0177 | 0.027 |
| in_past_farthest | 0.0170 | 0.0638 | 0.1470 | 0.0808 | 0.0234 | 0.035 |
| out_chosen_farthest | 0.0177 | 0.0653 | 0.1428 | 0.0862 | 0.0234 | 0.035 |
| chosen_nearest | 0.0194 | 0.0670 | 0.1320 | 0.1020 | 0.0177 | 0.027 |
| past_farthest | 0.0170 | 0.0626 | 0.1478 | <mark>**0.0802**</mark> | 0.0234 | 0.035 |
| chosen_farthest | 0.0176 | 0.0654 | 0.1470 | 0.0842 | 0.0234 | 0.035 |
| out_chosen_nearest | 0.0194 | 0.0681 | 0.1330 | 0.1020 | 0.0177 | 0.027 |
| out_past_nearest | 0.0200 | 0.0693 | 0.1318 | 0.1098 | 0.0182 | 0.028 |
| in_past_nearest | 0.0200 | 0.0685 | 0.1324 | 0.1094 | 0.0160 | 0.025 |
| past_nearest | 0.0200 | 0.0685 | 0.1324 | 0.1094 | 0.0160 | 0.025 |
| in_chosen_farthest | 0.0171 | 0.0644 | 0.1486 | 0.0834 | 0.0244 | 0.036 |
| Div_10_0.1_epoch_2_beta_0.1 | <mark>**0.0102**</mark> | 0.0431 | <mark>**0.1868**</mark> | 0.1066 | <mark>**0.0264**</mark> | <mark>**0.041**</mark> |
| Div_5_1.0_epoch_2_beta_0.1 | 0.0117 | 0.0481 | <mark>**0.1952**</mark> | 0.0986 | <mark>**0.0296**</mark> | <mark>**0.045**</mark> |
| Div_5_1.0_epoch_1_beta_0.1 | 0.0187 | 0.0661 | 0.1424 | 0.1068 | 0.0208 | 0.031 |
| Div_5_1.0_epoch_1_beta_2.0 | 0.0217 | 0.0756 | 0.1152 | 0.1044 | 0.0123 | 0.019 |
| Div_5_1.0_epoch_1_dpc_0.075_1.025 | 0.0206 | 0.0717 | 0.1328 | 0.0952 | 0.0186 | 0.028 |
| Div_5_1.0_epoch_1_dpc_0.025_1.075 | 0.0204 | 0.0710 | 0.1322 | 0.0946 | 0.0170 | 0.027 |
| Div_5_1.0_epoch_1_dpc_0.05_0.15 | 0.0184 | 0.0644 | 0.1440 | 0.1028 | 0.0229 | 0.034 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.025_1.075 | 0.0201 | 0.0694 | 0.1340 | 0.0982 | 0.0182 | 0.028 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.075_1.025 | 0.0201 | 0.0696 | 0.1344 | 0.0976 | 0.0181 | 0.028 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.05_0.15 | 0.0189 | 0.0669 | 0.1408 | 0.1070 | 0.0198 | 0.030 |

### Top-10 Metrics

| SampleMethod | MGU@10 ↓ | DGU@10 ↓ | DivRatio@10 ↑ | ORRatio@10 ↓ | NDCG@10 ↑ | HR@10 ↑ |
| --- | --- | --- | --- | --- | --- | --- |
| SPRec(Baseline) | 0.0228 | 0.0789 | 0.1266 | <mark>**0.0870**</mark> | 0.0140 | 0.022 | | 0.0141 | 0.0450 | 0.0968 | <mark>**0.0623**</mark> | 0.0158 | 0.028 |
| clusterout_high | 0.0125 | 0.0418 | 0.0979 | 0.0807 | 0.0167 | 0.028 |
| low_exposure | 0.0127 | 0.0452 | 0.0983 | 0.0656 | 0.0182 | 0.030 |
| high_exposure | 0.0129 | 0.0435 | 0.1027 | 0.0849 | 0.0165 | 0.028 |
| clusterin_high | 0.0129 | 0.0435 | <mark>**0.1032**</mark> | 0.0850 | 0.0165 | 0.028 |
| clusterout_low | 0.0129 | 0.0436 | 0.1026 | 0.0648 | <mark>**0.0230**</mark> | <mark>**0.039**</mark> |
| clusterin_low | 0.0125 | 0.0443 | 0.0978 | 0.0655 | 0.0186 | 0.032 |
| clusterin_high_clusterout_low | <mark>**0.0113**</mark> | <mark>**0.0404**</mark> | 0.0999 | <mark>**0.0623**</mark> | 0.0216 | 0.035 |
| balanced_popularity | 0.0119 | 0.0417 | 0.0983 | 0.0649 | 0.0214 | 0.035 |
| clusterin_low_clusterout_low | 0.0125 | 0.0457 | 0.0951 | 0.0626 | 0.0196 | 0.033 |
| LightGCN(all) | 0.0131 | 0.0413 | 0.0957 | 0.0787 | 0.01355 | 0.0250 |
| out_past_farthest | 0.0123 | 0.0433 | 0.1080 | 0.0561 | 0.0256 | 0.042 |
| in_chosen_nearest | 0.0124 | 0.0411 | 0.0990 | 0.0699 | 0.0190 | 0.031 |
| in_past_farthest | 0.0119 | 0.0428 | 0.1098 | 0.0557 | 0.0256 | 0.042 |
| out_chosen_farthest | 0.0122 | 0.0442 | 0.1074 | 0.0606 | 0.0256 | 0.042 |
| chosen_nearest | 0.0123 | 0.0412 | 0.0988 | 0.0700 | 0.0190 | 0.031 |
| past_farthest | 0.0119 | 0.0427 | 0.1100 | <mark>**0.0555**</mark> | 0.0256 | 0.042 |
| chosen_farthest | 0.0123 | 0.0448 | 0.1106 | 0.0588 | 0.0253 | 0.041 |
| out_chosen_nearest | 0.0126 | 0.0425 | 0.0997 | 0.0696 | 0.0193 | 0.032 |
| out_past_nearest | 0.0129 | 0.0428 | 0.0987 | 0.0758 | 0.0195 | 0.032 |
| in_past_nearest | 0.0126 | 0.0416 | 0.0986 | 0.0751 | 0.0172 | 0.029 |
| past_nearest | 0.0126 | 0.0416 | 0.0986 | 0.0751 | 0.0172 | 0.029 |
| in_chosen_farthest | 0.0120 | 0.0435 | 0.1117 | 0.0583 | 0.0260 | 0.041 |
| Div_10_0.1_epoch_2_beta_0.1 | 0.0097 | 0.0364 | <mark>**0.1322**</mark> | 0.0804 | <mark>**0.0287**</mark> | <mark>**0.048**</mark> |
| Div_5_1.0_epoch_2_beta_0.1  | 0.0102 | 0.0367 | <mark>**0.1375**</mark> | 0.0737 | <mark>**0.0321**</mark> | <mark>**0.053**</mark> |
| Div_5_1.0_epoch_1_beta_0.1 | 0.0128 | 0.0441 | 0.1064 | 0.0743 | 0.0221 | 0.035 |
| Div_5_1.0_epoch_1_beta_2.0 | 0.0134 | 0.0420 | 0.0913 | 0.0727 | 0.0142 | 0.025 |
| Div_5_1.0_epoch_1_dpc_0.075_1.025 | 0.0127 | 0.0431 | 0.1000 | 0.0629 | 0.0205 | 0.034 |
| Div_5_1.0_epoch_1_dpc_0.025_1.075 | 0.0130 | 0.0428 | 0.0997 | 0.0636 | 0.0186 | 0.032 |
| Div_5_1.0_epoch_1_dpc_0.05_0.15 | 0.0126 | 0.0436 | 0.1078 | 0.0716 | 0.0245 | 0.039 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.025_1.075 | 0.0125 | 0.0420 | 0.1002 | 0.0656 | 0.0198 | 0.033 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.075_1.025 | 0.0124 | 0.0423 | 0.1006 | 0.0652 | 0.0197 | 0.033 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.05_0.15 | 0.0128 | 0.0440 | 0.1060 | 0.0744 | 0.0211 | 0.034 |

### Predict Not-In-Ratio

| SampleMethod | Predict_NotIn_Ratio ↓ |
| --- | --- |
| SPRec(Baseline) |  <mark>**0.0623**</mark> | 
| clusterout_high | 0.8150 |
| low_exposure | 0.7490 |
| high_exposure | 0.8250 |
| clusterin_high | 0.8250 |
| clusterout_low | 0.7790 |
| clusterin_low | 0.7480 |
| clusterin_high_clusterout_low | 0.8000 |
| balanced_popularity | 0.7870 |
| clusterin_low_clusterout_low | 0.7700 |
| out_past_farthest | 0.7760 |
| in_chosen_nearest | 0.7720 |
| in_past_farthest | 0.7720 |
| out_chosen_farthest | 0.7790 |
| chosen_nearest | 0.7710 |
| past_farthest | 0.7760 |
| chosen_farthest | 0.7770 |
| out_chosen_nearest | 0.7730 |
| out_past_nearest | 0.7840 |
| in_past_nearest | 0.7830 |
| past_nearest | 0.7830 |
| in_chosen_farthest | 0.7790 |
| Div_10_0.1_epoch_2_beta_0.1 | 0.9150 |
| Div_5_0.1_epoch_2_beta_0.1 | 0.9030 |
| Div_5_1.0_epoch_1_beta_0.1 | 0.7960 |
| Div_5_1.0_epoch_1_beta_2.0 | <mark>**0.6910**</mark> |
| Div_5_1.0_epoch_1_dpc_0.075_1.025 | 0.7400 |
| Div_5_1.0_epoch_1_dpc_0.025_1.075 | 0.7370 |
| Div_5_1.0_epoch_1_dpc_0.05_0.15 | 0.7900 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.025_1.075 | 0.7490 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.075_1.025 | 0.7490 |
| t_0.5_Div_5_1.0_epoch_1_dpc_0.05_0.15 | 0.7940 |

## S-DPO(2 epochs) vs Curriculum Learning

### Top-5 Metrics

| SampleMethod | MGU@5 ↓ | DGU@5 ↓ | DivRatio@5 ↑ | ORRatio@5 ↓ | NDCG@5 ↑ | HR@5 ↑ |
| --- | --- | --- | --- | --- | --- | --- |
| two_stages clusterin_low_clusterout_low | 0.0130 | 0.0543 | 0.1724 | 0.1032 | 0.0244 | <mark>**0.037**</mark> |
| two_stages clusterin_high_clusterout_low | 0.0111 | 0.0463 | <mark>**0.1730**</mark> | 0.1210 | 0.0236 | 0.035 |
| two_epochs clusterin_low_clusterout_low | 0.0123 | 0.0539 | 0.1560 | 0.1014 | 0.0218 | 0.034 |
| two_epochs clusterin_high_clusterout_low | <mark>**0.0106**</mark> | <mark>**0.0391**</mark> | 0.1648 | 0.1182 | <mark>**0.0247**</mark> | 0.036 |

### Top-10 Metrics

| SampleMethod | MGU@10 ↓ | DGU@10 ↓ | DivRatio@10 ↑ | ORRatio@10 ↓ | NDCG@10 ↑ | HR@10 ↑ |
| --- | --- | --- | --- | --- | --- | --- |
| two_stages clusterin_low_clusterout_low | 0.0117 | 0.0440 | <mark>**0.1274**</mark> | 0.0752 | <mark>**0.0273**</mark> | <mark>**0.046**</mark> |
| two_stages clusterin_high_clusterout_low | 0.0103 | 0.0393 | 0.1257 | 0.0879 | 0.0259 | 0.042 |
| two_epochs clusterin_low_clusterout_low | 0.0109 | 0.0429 | 0.1150 | 0.0692 | 0.0237 | 0.040 |
| two_epochs clusterin_high_clusterout_low | <mark>**0.0093**</mark> | <mark>**0.0358**</mark> | 0.1208 | 0.0805 | 0.0268 | 0.043 |

### Predict Not-In-Ratio
| SampleMethod | Predict_NotIn_Ratio ↓ |
| --- | --- |
| two_stages clusterin_low_clusterout_low | 0.8730 |
| two_stages clusterin_high_clusterout_low | 0.9140 |
| two_epochs clusterin_low_clusterout_low | 0.8870 |
| two_epochs clusterin_high_clusterout_low | 0.9060 |

## Quick Start
### ClusterExposure
1. scripts/run_sft.py
2. scripts/run_beam_cd_candidates.py
3. scripts/run_annotate_candidates.py
4. scripts/run_cluster_exposure_neg_sampling.py
5. scripts/run_all_dpo.py
6. scripts/run_generate_predictions.py
7. scripts/run_evaluate.py

### SPRec_Reproduction
1. scripts/run_sft.py
2. scripts/run_generate_selfplay.py
3. scripts/run_dpo.py
4. scripts/run_generate_predictions.py
5. scripts/run_evaluate.py

## Directory Structure

```
ClusterExposure-DPO/
├── configs/                 # Config files (YAML)
├── scripts/                 # Entry points for each stage
├── src/
│   ├── dataset/             # Beam search, annotation, and sampling
│   ├── evaluation/          # Metric evaluation logic
│   └── models/              # DPO/SFT/SDPO training logic
├── experiments/
│   ├── data/                # Generated training/valid data
│   ├── model/               # Trained model checkpoints
│   ├── predictions/         # Inference outputs
│   └── metrics/             # Evaluation results
```